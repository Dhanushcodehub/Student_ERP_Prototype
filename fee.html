<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student ERP — Fee Management</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    .font-poppins { font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; }
    .font-roboto { font-family: "Roboto", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; }
    /* Gradient button style for consistent look */
    .btn-gradient {
      background-image: linear-gradient(135deg, #4da6ff, #1e90ff);
    }
    .btn-gradient:hover {
      filter: brightness(0.95);
    }
    .shadow-soft {
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    /* Scrollbar refinement for table */
    .thin-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .thin-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-white text-[#555] font-roboto">
  <!-- Top Navigation -->
  <nav class="fixed top-0 inset-x-0 bg-white shadow-sm z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <!-- Left: Logo + Title -->
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-[#e6f2ff] text-[#4da6ff] flex items-center justify-center font-bold">
  <svg class="w-6 h-6 text-[#4da6ff]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M3 21h18"></path>
    <path d="M5 21V9l7-4 7 4v12"></path>
    <path d="M9 21v-6h6v6"></path>
    <path d="M7 12h2M15 12h2"></path>
  </svg>
</div>
          <div class="font-poppins font-bold text-lg sm:text-xl text-gray-800">Fee Management</div>
        </div>
        <!-- Right: Icons -->
        <div class="flex items-center gap-2 sm:gap-3 relative">
          <button id="notifBtn" class="relative p-2 rounded-full hover:bg-[#e6f2ff] transition" aria-label="Notifications">
            <svg class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5"></path>
              <path d="M13.73 21a2 2 0 01-3.46 0"></path>
            </svg>
            <span id="notifDot" class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-[#e53935] rounded-full hidden"></span>
          </button>
          <div id="notifMenu" class="hidden absolute right-14 top-12 w-72 bg-white border border-gray-200 rounded-2xl shadow-lg p-3">
            <div class="font-poppins font-semibold text-gray-800 mb-2">Notifications</div>
            <ul id="notifList" class="space-y-2 text-sm">
              <!-- Filled by JS -->
            </ul>
          </div>

          <button id="profileBtn" class="p-2 rounded-full hover:bg-[#e6f2ff] transition" aria-label="Profile">
            <svg class="w-6 h-6 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
              <circle cx="12" cy="7" r="3"></circle>
            </svg>
          </button>
          <div id="profileMenu" class="hidden absolute right-0 top-12 w-44 bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
            <button class="w-full text-left px-4 py-2 hover:bg-[#e6f2ff]">My Profile</button>
            <button class="w-full text-left px-4 py-2 hover:bg-[#e6f2ff]">Settings</button>
            <button id="signOutBtn" class="w-full text-left px-4 py-2 hover:bg-[#e6f2ff]">Sign out</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16 space-y-8">
    <!-- 1) Fee Summary -->
    <section id="summaryCard" class="rounded-[20px] shadow-soft border border-gray-100 bg-white p-6 sm:p-8">
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
        <!-- Student Info -->
        <div class="space-y-3">
          <div class="text-sm uppercase tracking-wider text-gray-500">Student</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2">
            <div><span class="font-medium text-gray-700">Name:</span> <span id="studentName">Jane Doe</span></div>
            <div><span class="font-medium text-gray-700">Roll No:</span> <span id="studentRoll">23CS045</span></div>
            <div><span class="font-medium text-gray-700">Course:</span> <span id="studentCourse">B.Tech CSE</span></div>
            <div><span class="font-medium text-gray-700">Semester:</span> <span id="studentSem">Spring 2025</span></div>
          </div>
        </div>

        <!-- Totals -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 w-full md:w-auto">
          <div class="rounded-2xl border border-gray-200 p-4 text-center">
            <div class="text-xs uppercase text-gray-500 mb-1">Total Fee</div>
            <div id="totalFee" class="font-poppins text-2xl font-bold text-gray-800">₹0</div>
            <div id="scholarshipNote" class="text-[11px] text-[#4da6ff] mt-1 hidden"></div>
          </div>
          <div class="rounded-2xl border border-gray-200 p-4 text-center">
            <div class="text-xs uppercase text-gray-500 mb-1">Paid</div>
            <div id="paidAmount" class="font-poppins text-2xl font-bold text-gray-800">₹0</div>
          </div>
          <div class="rounded-2xl border border-gray-200 p-4 text-center">
            <div class="text-xs uppercase text-gray-500 mb-1">Balance</div>
            <div id="balanceAmount" class="font-poppins text-2xl font-bold">₹0</div>
          </div>
          <div class="rounded-2xl border border-gray-200 p-4 text-center">
            <div class="text-xs uppercase text-gray-500 mb-1 flex items-center justify-center gap-1">Due Date <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div>
            <div id="nextDueDate" class="font-poppins text-lg font-semibold text-gray-800">—</div>
          </div>
        </div>
      </div>
      <div class="mt-6 flex items-center gap-3">
        <span id="overallStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium text-white bg-[#28a745]">Paid</span>
        <span class="text-sm text-gray-500">Overall status</span>
      </div>
    </section>

    <!-- 2) Detailed Fee Structure -->
    <section class="space-y-4">
      <!-- Filters -->
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <div class="font-poppins font-semibold text-gray-800 text-lg">Detailed Fee Structure</div>
        <div class="flex flex-wrap gap-3">
          <select id="semesterFilter" class="rounded-xl border border-gray-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#4da6ff]">
            <option value="All">All Semesters</option>
          </select>
          <select id="typeFilter" class="rounded-xl border border-gray-300 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#4da6ff]">
            <option value="All">All Fee Types</option>
          </select>
        </div>
      </div>

      <!-- Table Card -->
      <div class="rounded-[20px] shadow-soft border border-gray-100 bg-white p-4 sm:p-6">
        <div class="hidden md:block">
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-gray-700">
              <thead class="sticky top-0 bg-white z-10 border-b">
                <tr class="text-left">
                  <th class="py-3 px-4 font-medium">Fee Head</th>
                  <th class="py-3 px-4 font-medium">Amount</th>
                  <th class="py-3 px-4 font-medium">Status</th>
                  <th class="py-3 px-4 font-medium">Due Date</th>
                  <th class="py-3 px-4 font-medium">Receipt</th>
                </tr>
              </thead>
            </table>
          </div>
          <div class="max-h-96 overflow-y-auto thin-scroll border-t">
            <table class="min-w-full text-sm">
              <tbody id="feeTableBody" class="divide-y">
                <!-- Rows injected by JS; alternate row coloring applied via JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Mobile List -->
        <div class="block md:hidden">
          <div id="feeCards" class="space-y-3">
            <!-- Cards injected by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- 3) Payment & Scholarships -->
    <section class="space-y-4">
      <div class="font-poppins font-semibold text-gray-800 text-lg">Payment & Scholarships</div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Payment Card -->
        <div class="lg:col-span-2 rounded-[20px] shadow-soft border border-gray-100 bg-white p-6 sm:p-8 relative">
          <div class="flex items-center justify-between">
            <div class="font-poppins font-semibold text-gray-800 text-xl">Make Payment</div>
            <span class="text-xs px-2.5 py-1 rounded-full bg-[#e6f2ff] text-[#4da6ff]">Demo only — no real charges</span>
          </div>

          <!-- Selection -->
          <form id="paymentForm" class="mt-6 space-y-5">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Select pending fee head(s)</label>
              <!-- Custom multiselect -->
              <div class="relative">
                <button id="feeSelectBtn" type="button" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-left flex items-center justify-between hover:border-[#4da6ff] focus:outline-none focus:ring-2 focus:ring-[#4da6ff]">
                  <span id="selectedSummary" class="truncate text-gray-600">None selected</span>
                  <svg class="w-4 h-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                </button>
                <div id="feeSelectMenu" class="hidden absolute z-20 mt-2 w-full bg-white border border-gray-200 rounded-2xl shadow-lg p-3 max-h-64 overflow-y-auto thin-scroll">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600">Pending & overdue this semester</span>
                    <button id="selectAllBtn" type="button" class="text-sm text-[#4da6ff] hover:underline">Select all</button>
                  </div>
                  <ul id="pendingList" class="space-y-2">
                    <!-- options by JS -->
                  </ul>
                </div>
              </div>
            </div>

            <!-- Totals -->
            <div class="rounded-xl bg-[#e6f2ff] p-4">
              <div class="flex items-center justify-between text-sm">
                <span>Subtotal</span>
                <span id="subtotalText" class="font-medium text-gray-800">₹0</span>
              </div>
              <div id="scholarshipApplyRow" class="hidden flex items-center justify-between text-sm mt-1">
                <span>Scholarship applied</span>
                <span id="scholarshipApplyText" class="font-medium text-[#28a745]">−₹0</span>
              </div>
              <div class="border-t border-[#cde6ff] my-3"></div>
              <div class="flex items-center justify-between">
                <span class="font-medium text-gray-800">Total to pay</span>
                <span id="totalToPayText" class="font-poppins text-xl font-bold text-gray-900">₹0</span>
              </div>
            </div>

            <!-- Pay Button -->
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
              <button id="payBtn" type="submit" class="btn-gradient text-white font-medium px-5 py-3 rounded-xl flex items-center justify-center gap-2 w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="5" width="20" height="14" rx="2" ry="2"></rect>
                  <line x1="2" y1="10" x2="22" y2="10"></line>
                </svg>
                <span>Proceed to Pay</span>
              </button>
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <!-- Simple payment method icons -->
                <div class="flex items-center gap-1.5">
                  <svg class="w-7 h-7" viewBox="0 0 48 48"><rect x="6" y="10" width="36" height="28" rx="6" fill="#e6f2ff" stroke="#4da6ff"/><text x="24" y="28" text-anchor="middle" font-size="10" fill="#4da6ff" font-family="Arial, sans-serif">UPI</text></svg>
                  <svg class="w-7 h-7" viewBox="0 0 48 48"><rect x="6" y="10" width="36" height="28" rx="6" fill="#e6f2ff" stroke="#4da6ff"/><text x="24" y="28" text-anchor="middle" font-size="10" fill="#4da6ff" font-family="Arial, sans-serif">CARD</text></svg>
                  <svg class="w-7 h-7" viewBox="0 0 48 48"><rect x="6" y="10" width="36" height="28" rx="6" fill="#e6f2ff" stroke="#4da6ff"/><text x="24" y="28" text-anchor="middle" font-size="8" fill="#4da6ff" font-family="Arial, sans-serif">NET</text></svg>
                  <svg class="w-7 h-7" viewBox="0 0 48 48"><rect x="6" y="10" width="36" height="28" rx="6" fill="#e6f2ff" stroke="#4da6ff"/><text x="24" y="28" text-anchor="middle" font-size="8" fill="#4da6ff" font-family="Arial, sans-serif">WAL</text></svg>
                </div>
              </div>
            </div>
          </form>

          <!-- Processing overlay -->
          <div id="processingOverlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-[1px] rounded-[20px] flex items-center justify-center">
            <div class="text-center">
              <div class="w-12 h-12 border-4 border-[#e6f2ff] border-t-[#4da6ff] rounded-full animate-spin mx-auto mb-3"></div>
              <div class="font-medium text-gray-700">Processing payment...</div>
              <div class="text-xs text-gray-500 mt-1">This is a demo; no real money moves</div>
            </div>
          </div>
        </div>

        <!-- Scholarship Card -->
        <div class="rounded-[20px] shadow-soft border border-gray-100 bg-white p-6 sm:p-8">
          <div class="font-poppins font-semibold text-gray-800 text-xl mb-4">Scholarship / Waiver</div>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Type</span>
              <span id="schType" class="font-medium text-gray-800">—</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Amount reduced</span>
              <span id="schAmount" class="font-medium text-[#28a745]">₹0</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Approval status</span>
              <span id="schStatus" class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium text-white bg-[#28a745]">Approved</span>
            </div>
            <div class="rounded-xl bg-[#e6f2ff] p-3 text-xs text-gray-700">
              Scholarship automatically applies to eligible fee head(s) at payment time.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed top-20 right-4 z-[60] hidden">
    <div class="rounded-xl bg-gray-900 text-white px-4 py-3 shadow-lg text-sm flex items-center gap-2">
      <span id="toastText">Done</span>
      <button onclick="hideToast()" class="ml-2 text-white/80 hover:text-white" aria-label="Close">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // --- Data ---
    const student = {
      name: "Jane Doe",
      roll: "23CS045",
      course: "B.Tech CSE",
      currentSemester: "Spring 2025",
    };

    // Fee dataset (small sample)
    let fees = [
      { id: "SPR25-TUI", head: "Tuition", amount: 50000, status: "Pending", dueDate: "2025-10-01", semester: "Spring 2025" },
      { id: "SPR25-HOS", head: "Hostel", amount: 20000, status: "Paid", dueDate: "2025-08-01", semester: "Spring 2025", paidOn: "2025-08-15", transactionId: "TXN-984351" },
      { id: "SPR25-TRA", head: "Transport", amount: 5000, status: "Pending", dueDate: "2025-09-25", semester: "Spring 2025" },
      { id: "SPR25-EXM", head: "Exam", amount: 2000, status: "Overdue", dueDate: "2025-09-10", semester: "Spring 2025" },
      { id: "F24-LIB", head: "Library", amount: 800, status: "Paid", dueDate: "2024-11-01", semester: "Fall 2024", paidOn: "2024-11-02", transactionId: "TXN-771240" },
      { id: "F24-EXM", head: "Exam", amount: 1800, status: "Paid", dueDate: "2024-10-10", semester: "Fall 2024", paidOn: "2024-10-05", transactionId: "TXN-661240" },
    ];

    // Scholarship applies to Tuition of Spring 2025
    const scholarship = {
      type: "Merit Scholarship",
      amount: 15000,
      status: "Approved",
      appliesTo: "Tuition",
      semester: "Spring 2025",
      remainingAmount: 15000, // will be consumed when Tuition is paid
    };

    // --- Helpers ---
    const el = (id) => document.getElementById(id);
    const formatCurrency = (n) => "₹" + Number(n).toLocaleString("en-IN");
    const parseDate = (s) => (s ? new Date(s + "T00:00:00") : null);

    function badge(status) {
      // Map to colors
      let color = "#28a745";
      if (status === "Pending") color = "#ff9800";
      if (status === "Overdue") color = "#e53935";
      return `<span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium text-white" style="background:${color}">${status}</span>`;
    }

    function nextDueDateForSemester(sem) {
      const items = fees.filter(f => f.semester === sem && (f.status === "Pending" || f.status === "Overdue"));
      if (!items.length) return "—";
      items.sort((a,b) => parseDate(a.dueDate) - parseDate(b.dueDate));
      return items[0].dueDate;
    }

    function computeSummary(sem) {
      const items = fees.filter(f => f.semester === sem);
      const paid = items.filter(f => f.status === "Paid").reduce((s, r) => s + r.amount, 0);
      const pendingOrOverdue = items.filter(f => f.status !== "Paid").reduce((s, r) => s + r.amount, 0);
      // Apply remaining scholarship to balance view (so user sees reduced balance)
      const scholarshipImpact = (scholarship.status === "Approved" && scholarship.semester === sem) ? scholarship.remainingAmount : 0;
      const balance = Math.max(pendingOrOverdue - scholarshipImpact, 0);
      const total = paid + balance;

      let overall = "Paid";
      if (items.some(f => f.semester === sem && f.status === "Overdue")) overall = "Overdue";
      else if (items.some(f => f.semester === sem && f.status === "Pending")) overall = "Pending";

      return { total, paid, balance, overall, scholarshipImpact };
    }

    function setBalanceColor(overall) {
      const balance = el("balanceAmount");
      balance.classList.remove("text-[#28a745]", "text-[#ff9800]", "text-[#e53935]", "text-gray-800");
      if (overall === "Overdue") balance.classList.add("text-[#e53935]");
      else if (overall === "Pending") balance.classList.add("text-[#ff9800]");
      else balance.classList.add("text-[#28a745]");
    }

    // --- Rendering ---
    function renderSummary() {
      el("studentName").textContent = student.name;
      el("studentRoll").textContent = student.roll;
      el("studentCourse").textContent = student.course;
      el("studentSem").textContent = student.currentSemester;

      const { total, paid, balance, overall, scholarshipImpact } = computeSummary(student.currentSemester);
      el("totalFee").textContent = formatCurrency(total);
      el("paidAmount").textContent = formatCurrency(paid);
      el("balanceAmount").textContent = formatCurrency(balance);
      el("overallStatus").textContent = overall;
      el("overallStatus").style.background = overall === "Overdue" ? "#e53935" : (overall === "Pending" ? "#ff9800" : "#28a745");
      setBalanceColor(overall);

      const due = nextDueDateForSemester(student.currentSemester);
      el("nextDueDate").textContent = due ?? "—";

      // Scholarship note
      const note = el("scholarshipNote");
      if (scholarship.status === "Approved" && scholarship.semester === student.currentSemester && scholarship.remainingAmount > 0) {
        note.classList.remove("hidden");
        note.textContent = `Includes potential scholarship of ${formatCurrency(scholarship.remainingAmount)}`;
      } else {
        note.classList.add("hidden");
      }
    }

    function getFilteredFees() {
      const sem = el("semesterFilter").value;
      const type = el("typeFilter").value;
      return fees.filter(f => (sem === "All" || f.semester === sem) && (type === "All" || f.head === type));
    }

    function renderTable() {
      const rows = getFilteredFees().sort((a,b) => parseDate(a.dueDate) - parseDate(b.dueDate));
      const tbody = el("feeTableBody");
      tbody.innerHTML = "";

      rows.forEach((f, idx) => {
        const tr = document.createElement("tr");
        tr.className = (idx % 2 === 0) ? "bg-white" : "bg-gray-50";
        tr.innerHTML = `
          <td class="py-3 px-4">
            <div class="font-medium text-gray-800">${f.head}</div>
            <div class="text-xs text-gray-500">${f.semester}</div>
          </td>
          <td class="py-3 px-4">${formatCurrency(f.amount)}</td>
          <td class="py-3 px-4">${badge(f.status)}</td>
          <td class="py-3 px-4">${f.dueDate || "—"}</td>
          <td class="py-3 px-4">
            ${f.status === "Paid"
              ? `<button data-receipt="${f.id}" class="text-[#4da6ff] hover:underline inline-flex items-center gap-1"><svg class='w-4 h-4' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'></path><polyline points='14 2 14 8 20 8'></polyline><path d='M12 18v-6'></path><path d='M9 15l3 3 3-3'></path></svg> Download</button>`
              : `<span class="text-gray-400 text-sm">Not available</span>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Receipt handlers
      tbody.querySelectorAll("[data-receipt]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-receipt");
          downloadReceipt(id);
        });
      });
    }

    function renderCards() {
      const items = getFilteredFees().sort((a,b) => parseDate(a.dueDate) - parseDate(b.dueDate));
      const wrap = el("feeCards");
      wrap.innerHTML = "";

      items.forEach((f) => {
        const card = document.createElement("div");
        card.className = "rounded-2xl border border-gray-200 p-4";
        card.innerHTML = `
          <details class="group">
            <summary class="flex items-center justify-between cursor-pointer">
              <div>
                <div class="font-medium text-gray-800">${f.head}</div>
                <div class="text-xs text-gray-500">${f.semester}</div>
              </div>
              <div class="flex items-center gap-3">
                <div class="font-poppins font-semibold text-gray-800">${formatCurrency(f.amount)}</div>
                <div>${badge(f.status)}</div>
                <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
              </div>
            </summary>
            <div class="mt-3 pt-3 border-t">
              <div class="text-sm flex items-center justify-between">
                <span class="text-gray-600">Due Date</span>
                <span>${f.dueDate || "—"}</span>
              </div>
              <div class="mt-3">
                ${f.status === "Paid"
                  ? `<button data-receipt="${f.id}" class="w-full text-[#4da6ff] border border-[#4da6ff] hover:bg-[#e6f2ff] transition rounded-xl px-3 py-2 flex items-center justify-center gap-2"><svg class='w-4 h-4' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'></path><polyline points='14 2 14 8 20 8'></polyline><path d='M12 18v-6'></path><path d='M9 15l3 3 3-3'></path></svg> Download Receipt</button>`
                  : `<button disabled class="w-full text-gray-400 border border-gray-300 rounded-xl px-3 py-2">Receipt not available</button>`
                }
              </div>
            </div>
          </details>
        `;
        wrap.appendChild(card);
      });

      // Receipt handlers
      wrap.querySelectorAll("[data-receipt]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-receipt");
          downloadReceipt(id);
        });
      });
    }

    function renderFilters() {
      const semesters = Array.from(new Set(fees.map(f => f.semester)));
      const types = Array.from(new Set(fees.map(f => f.head)));

      const semSel = el("semesterFilter");
      const typeSel = el("typeFilter");

      // Fill semesters (keep "All" first)
      const currentSem = student.currentSemester;
      const existingSems = Array.from(semSel.options).map(o => o.value);
      semesters.forEach(s => {
        if (!existingSems.includes(s)) {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          semSel.appendChild(opt);
        }
      });
      // Default to current semester in view to keep it focused
      semSel.value = currentSem;

      // Fill types
      typeSel.innerHTML = `<option value="All">All Fee Types</option>` + types.map(t => `<option value="${t}">${t}</option>`).join("");
    }

    function renderScholarshipCard() {
      el("schType").textContent = scholarship.type;
      el("schAmount").textContent = scholarship.status === "Approved" ? `−${formatCurrency(scholarship.amount)}` : "—";
      const s = el("schStatus");
      s.textContent = scholarship.status;
      s.style.background = scholarship.status === "Approved" ? "#28a745" : (scholarship.status === "Pending" ? "#ff9800" : "#e53935");
    }

    // --- Payment selection ---
    const selected = new Set(); // selected fee ids in payment
    function pendingForCurrentSemester() {
      return fees.filter(f =>
        f.semester === student.currentSemester &&
        (f.status === "Pending" || f.status === "Overdue")
      );
    }

    function renderPendingMenu() {
      const list = el("pendingList");
      const items = pendingForCurrentSemester();
      list.innerHTML = "";

      if (!items.length) {
        list.innerHTML = `<div class="text-sm text-gray-500">No pending items 🎉</div>`;
        return;
      }

      items.forEach(it => {
        const id = `opt-${it.id}`;
        const li = document.createElement("li");
        li.innerHTML = `
          <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-[#f8fbff] cursor-pointer">
            <input id="${id}" type="checkbox" ${selected.has(it.id) ? "checked" : ""} class="w-4 h-4 text-[#4da6ff] border-gray-300 rounded">
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-800">${it.head}</span>
                <span class="text-sm font-semibold text-gray-800">${formatCurrency(it.amount)}</span>
              </div>
              <div class="text-xs text-gray-500">Due: ${it.dueDate} • ${it.status}</div>
            </div>
          </label>
        `;
        list.appendChild(li);

        li.querySelector("input").addEventListener("change", (e) => {
          if (e.target.checked) selected.add(it.id);
          else selected.delete(it.id);
          updateSelectionSummary();
        });
      });
    }

    function updateSelectionSummary() {
      const items = pendingForCurrentSemester().filter(i => selected.has(i.id));
      const titles = items.map(i => i.head);
      el("selectedSummary").textContent = items.length ? titles.join(", ") : "None selected";

      // Calculate totals with scholarship if Tuition selected and scholarship remains
      const subtotal = items.reduce((s, r) => s + r.amount, 0);
      let schApplied = 0;
      if (scholarship.status === "Approved" && scholarship.semester === student.currentSemester && scholarship.remainingAmount > 0) {
        if (items.some(i => i.head === scholarship.appliesTo)) {
          schApplied = Math.min(scholarship.remainingAmount, items.find(i => i.head === scholarship.appliesTo).amount);
          el("scholarshipApplyRow").classList.remove("hidden");
          el("scholarshipApplyText").textContent = "−" + formatCurrency(schApplied);
        } else {
          el("scholarshipApplyRow").classList.add("hidden");
        }
      } else {
        el("scholarshipApplyRow").classList.add("hidden");
      }

      el("subtotalText").textContent = formatCurrency(subtotal);
      el("totalToPayText").textContent = formatCurrency(Math.max(subtotal - schApplied, 0));
      el("payBtn").disabled = items.length === 0;
    }

    // --- Receipt generation ---
    function downloadReceipt(id) {
      const item = fees.find(f => f.id === id);
      if (!item || item.status !== "Paid") return;

      const lines = [
        "STUDENT ERP — PAYMENT RECEIPT",
        "----------------------------------------",
        `Receipt ID: R-${id}-${(item.transactionId || "TXN").slice(-6)}`,
        `Date: ${item.paidOn || new Date().toISOString().slice(0,10)}`,
        "",
        `Student: ${student.name} (${student.roll})`,
        `Course: ${student.course}`,
        `Semester: ${item.semester}`,
        "",
        `Fee Head: ${item.head}`,
        `Amount Paid: ${formatCurrency(item.amount)}`,
        item.head === scholarship.appliesTo && item.semester === scholarship.semester && item._schAppliedOnPay
          ? `Scholarship Applied: −${formatCurrency(item._schAppliedOnPay)}`
          : "",
        "",
        `Transaction: ${item.transactionId || "TXN-" + Math.random().toString(36).slice(2,10).toUpperCase()}`,
        "Status: SUCCESS",
        "",
        "Thank you for your payment."
      ].filter(Boolean).join("\n");

      const blob = new Blob([lines], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `Receipt_${id}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // --- Notifications ---
    function renderNotifications() {
      const notifList = el("notifList");
      notifList.innerHTML = "";
      const curr = fees.filter(f => f.semester === student.currentSemester);
      const hasOverdue = curr.some(f => f.status === "Overdue");
      const hasPending = curr.some(f => f.status === "Pending");

      if (hasOverdue) {
        const li = document.createElement("li");
        li.innerHTML = `<div class="p-2 rounded-lg bg-red-50 border border-red-100 text-[13px]"><span class="font-medium text-red-700">Overdue:</span> Some fees have crossed the due date.</div>`;
        notifList.appendChild(li);
      }
      if (hasPending) {
        const li = document.createElement("li");
        li.innerHTML = `<div class="p-2 rounded-lg bg-orange-50 border border-orange-100 text-[13px]"><span class="font-medium text-orange-700">Reminder:</span> Pending fees are due soon.</div>`;
        notifList.appendChild(li);
      }
      if (!hasOverdue && !hasPending) {
        const li = document.createElement("li");
        li.innerHTML = `<div class="p-2 rounded-lg bg-green-50 border border-green-100 text-[13px] text-green-700">All fees are paid. Great job!</div>`;
        notifList.appendChild(li);
      }

      // Dot
      el("notifDot").classList.toggle("hidden", !(hasOverdue || hasPending));
    }

    // --- UI Events ---
    function showToast(msg) {
      el("toastText").textContent = msg;
      el("toast").classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => hideToast(), 3000);
    }
    function hideToast() {
      el("toast").classList.add("hidden");
    }

    // Process Payment (Demo)
    function processPayment(e) {
      e.preventDefault();

      const items = pendingForCurrentSemester().filter(i => selected.has(i.id));
      if (!items.length) return;

      // Show processing overlay
      el("processingOverlay").classList.remove("hidden");
      el("payBtn").disabled = true;

      setTimeout(() => {
        // Apply scholarship once if Tuition is in selection
        let schAppliedNow = 0;
        if (scholarship.status === "Approved" && scholarship.semester === student.currentSemester && scholarship.remainingAmount > 0) {
          const tuitionItem = items.find(i => i.head === scholarship.appliesTo);
          if (tuitionItem) {
            schAppliedNow = Math.min(scholarship.remainingAmount, tuitionItem.amount);
            scholarship.remainingAmount -= schAppliedNow;
            // Remember amount applied on Tuition receipt
            const feeRef = fees.find(f => f.id === tuitionItem.id);
            if (feeRef) feeRef._schAppliedOnPay = schAppliedNow;
          }
        }

        // Mark selected as paid
        const today = new Date().toISOString().slice(0,10);
        items.forEach(it => {
          const f = fees.find(x => x.id === it.id);
          if (f) {
            f.status = "Paid";
            f.paidOn = today;
            f.transactionId = "TXN-" + Math.random().toString(36).slice(2,10).toUpperCase();
          }
        });

        // Clear selection
        selected.clear();
        el("feeSelectMenu").classList.add("hidden");

        // Update UI
        renderSummary();
        renderPendingMenu();
        updateSelectionSummary();
        renderTable();
        renderCards();
        renderNotifications();

        el("processingOverlay").classList.add("hidden");
        el("payBtn").disabled = false;
        showToast("Payment successful. Receipts are ready to download.");
      }, 1600);
    }

    // --- Init ---
    function init() {
      // Summary
      renderSummary();

      // Filters
      renderFilters();
      el("semesterFilter").addEventListener("change", () => { renderTable(); renderCards(); });
      el("typeFilter").addEventListener("change", () => { renderTable(); renderCards(); });

      // Table + Cards
      renderTable();
      renderCards();

      // Scholarship
      renderScholarshipCard();

      // Payment menu
      renderPendingMenu();
      updateSelectionSummary();

      // Events
      el("feeSelectBtn").addEventListener("click", () => {
        el("feeSelectMenu").classList.toggle("hidden");
      });
      document.addEventListener("click", (ev) => {
        const menu = el("feeSelectMenu");
        if (!menu.contains(ev.target) && !el("feeSelectBtn").contains(ev.target)) {
          menu.classList.add("hidden");
        }
        // Close notification/profile menus if clicking outside
        if (!el("notifMenu").contains(ev.target) && !el("notifBtn").contains(ev.target)) {
          el("notifMenu").classList.add("hidden");
        }
        if (!el("profileMenu").contains(ev.target) && !el("profileBtn").contains(ev.target)) {
          el("profileMenu").classList.add("hidden");
        }
      });

      el("selectAllBtn").addEventListener("click", () => {
        pendingForCurrentSemester().forEach(i => selected.add(i.id));
        renderPendingMenu();
        updateSelectionSummary();
      });

      el("paymentForm").addEventListener("submit", processPayment);

      // Top bar menus
      el("notifBtn").addEventListener("click", () => {
        el("notifMenu").classList.toggle("hidden");
      });
      el("profileBtn").addEventListener("click", () => {
        el("profileMenu").classList.toggle("hidden");
      });
      el("signOutBtn").addEventListener("click", (e) => {
        e.preventDefault();
        showToast("This is a demo. Sign out is not enabled.");
      });

      // Notifications
      renderNotifications();
    }

    init();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9827ac37d5848030',t:'MTc1ODQzNzg5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
